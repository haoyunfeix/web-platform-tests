<!doctype html>
<html>
  <head>
    <meta charset=utf-8>
    <title>WebVR IDL test</title>
    <link rel="help" href="https://w3c.github.io/webvr/">

    <script src=/resources/testharness.js></script>
    <script src=/resources/testharnessreport.js></script>
    <script src=/resources/WebIDLParser.js></script>
    <script src=/resources/idlharness.js></script>
<script id="webvr_idl" type=text/plain>
// Editorâ€™s Draft, 2 October 2017
// https://w3c.github.io/webvr/spec/latest/

[SecureContext, Exposed=Window] interface VR : EventTarget {
  // Methods
  Promise<sequence<VRDevice>> getDevices();

  // Events
  attribute EventHandler ondeviceconnect;
  attribute EventHandler ondevicedisconnect;
};

[SecureContext, Exposed=Window] interface VRDevice : EventTarget {
  // Attributes
  readonly attribute DOMString deviceName;
  readonly attribute boolean isExternal;

  // Methods
  Promise<void> supportsSession(optional VRSessionCreationOptions parameters);
  Promise<VRSession> requestSession(optional VRSessionCreationOptions parameters);

  // Events
  attribute EventHandler ondeactivate;
};

[SecureContext, Exposed=Window] interface VRSession : EventTarget {
  // Attributes
  readonly attribute VRDevice device;
  readonly attribute boolean exclusive;
  readonly attribute VRPresentationContext outputContext;

  attribute double depthNear;
  attribute double depthFar;
  attribute VRLayer baseLayer;

  // Methods
  Promise<VRFrameOfReference> requestFrameOfReference(VRFrameOfReferenceType type, optional VRFrameOfReferenceOptions options);

  long requestFrame(VRFrameRequestCallback callback);
  void cancelFrame(long handle);

  Promise<void> end();

  // Events
  attribute EventHandler onblur;
  attribute EventHandler onfocus;
  attribute EventHandler onresetpose;
  attribute EventHandler onend;
};

dictionary VRSessionCreationOptions {
  boolean exclusive = false;
  VRPresentationContext outputContext;
};

callback VRFrameRequestCallback = void (VRPresentationFrame frame);

[SecureContext, Exposed=Window] interface VRPresentationFrame {
  readonly attribute FrozenArray<VRView> views;

  VRDevicePose? getDevicePose(VRCoordinateSystem coordinateSystem);
};

[SecureContext, Exposed=Window] interface VRView {
  readonly attribute VREye eye;
  readonly attribute Float32Array projectionMatrix;

  VRViewport? getViewport(VRLayer layer);
};

enum VREye {
  "left",
  "right"
};

[SecureContext, Exposed=Window] interface VRViewport {
  readonly attribute long x;
  readonly attribute long y;
  readonly attribute long width;
  readonly attribute long height;
};

[SecureContext, Exposed=Window] interface VRDevicePose {
  readonly attribute Float32Array poseModelMatrix;

  Float32Array getViewMatrix(VRView view);
};

[SecureContext, Exposed=Window] interface VRLayer {};

typedef (WebGLRenderingContext or
         WebGL2RenderingContext) VRWebGLRenderingContext;

[SecureContext, Exposed=Window, Constructor(VRSession session,
             VRWebGLRenderingContext context,
             optional VRWebGLLayerInit layerInit)]
interface VRWebGLLayer : VRLayer {
  // Attributes
  readonly attribute VRWebGLRenderingContext context;

  readonly attribute boolean antialias;
  readonly attribute boolean depth;
  readonly attribute boolean stencil;
  readonly attribute boolean alpha;
  readonly attribute boolean multiview;

  readonly attribute WebGLFramebuffer framebuffer;
  readonly attribute unsigned long framebufferWidth;
  readonly attribute unsigned long framebufferHeight;

  // Methods
  void requestViewportScaling(double viewportScaleFactor);
};

dictionary VRWebGLLayerInit {
  boolean antialias = true;
  boolean depth = false;
  boolean stencil = false;
  boolean alpha = true;
  boolean multiview = false;
  double framebufferScaleFactor;
};

partial dictionary WebGLContextAttributes {
    VRDevice compatibleVRDevice = null;
};

//partial interface WebGLRenderingContextBase {
//    Promise<void> setCompatibleVRDevice(VRDevice device);
//};

[SecureContext, Exposed=Window] interface VRPresentationContext {
  readonly attribute HTMLCanvasElement canvas;
};

[SecureContext, Exposed=Window] interface VRCoordinateSystem : EventTarget {
  Float32Array? getTransformTo(VRCoordinateSystem other);
};

enum VRFrameOfReferenceType {
  "headModel",
  "eyeLevel",
  "stage",
};

dictionary VRFrameOfReferenceOptions {
  boolean disableStageEmulation = false;
  double stageEmulationHeight = 0.0;
};

[SecureContext, Exposed=Window] interface VRFrameOfReference : VRCoordinateSystem {
  readonly attribute VRStageBounds? bounds;
  readonly attribute double emulatedHeight;

  attribute EventHandler onboundschange;
};

[SecureContext, Exposed=Window] interface VRStageBounds {
  readonly attribute FrozenArray<VRStageBoundsPoint> geometry;
};

[SecureContext, Exposed=Window] interface VRStageBoundsPoint {
  readonly attribute double x;
  readonly attribute double z;
};

[SecureContext, Exposed=Window, Constructor(DOMString type, VRDeviceEventInit eventInitDict)]
interface VRDeviceEvent : Event {
  readonly attribute VRDevice device;
};

dictionary VRDeviceEventInit : EventInit {
  required VRDevice device;
};

[SecureContext, Exposed=Window, Constructor(DOMString type, VRSessionEventInit eventInitDict)]
interface VRSessionEvent : Event {
  readonly attribute VRSession session;
};

dictionary VRSessionEventInit : EventInit {
  required VRSession session;
};

[SecureContext, Exposed=Window, Constructor(DOMString type, VRCoordinateSystemEventInit eventInitDict)]
interface VRCoordinateSystemEvent : Event {
  readonly attribute VRCoordinateSystem coordinateSystem;
};

dictionary VRCoordinateSystemEventInit : EventInit {
  required VRCoordinateSystem coordinateSystem;
};

partial interface Navigator {
  [SameObject] readonly attribute VR vr;
};

</script>
  </head>
  <body>
    <h1 class="instructions">Description</h1>
    <p class="instructions">
      This test verifies that implementations of the WebVR API match its WebIDL definition.
    </p>

    <div id='log'></div>

    <script>
      setup( () => {
        var idl_array = new IdlArray();
        idl_array.add_untested_idls("[PrimaryGlobal] interface Window {};");
        idl_array.add_untested_idls("interface Navigator {};");
        idl_array.add_untested_idls("interface Event {};");
        idl_array.add_untested_idls("interface EventTarget {};");
        idl_array.add_untested_idls("interface HTMLIFrameElement {};");
        idl_array.add_untested_idls("interface Gamepad {};");

        idl_array.add_idls(document.getElementById("webvr_idl").textContent);

        idl_array.test();
        done();
      }, {explicit_done: true});
    </script>
  </body>
</html>
